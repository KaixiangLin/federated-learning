% !TEX ROOT=./main.tex

In this section, we study the convergence of accelerated FedAve 
algorithm for convex, non-smooth function.

\begin{itemize}
	\item MGD vs NASGD
	\begin{align}
	\vy^k_{t+1} &= \gamma \vy^k_t + \grad F_k(\vw^k_{t})	\\
	\vw^k_{t+1} & = \vw^k_{t} - \eta \vy^k_{t+1}
	\end{align}
	\begin{align}
	\vy^k_{t+1} &= \vw^k_{t} - \alpha \grad F_k(\vw^k_{t})	\\
	\vw^k_{t+1} & = \vy^k_{t+1} + \beta(\vy^k_{t+1} - \vy^k_{t})
	\end{align}
	
\end{itemize}

\textbf{NASGD updates}
\begin{align}
	\vy^k_{t+1} &= \vw^k_{t} - \alpha  \vg_{t,k}	\\
	\vw^k_{t+1} & = \vy^k_{t+1} + \beta(\vy^k_{t+1} - \vy^k_{t})
\end{align}
$\vp_t$ satisfies the recursive equation:
\begin{align}
	\ov{p}_{t}=\left\{\begin{array}{l}\frac{\beta}{1-\beta}\left[\ov{w}_{t}-\ov{w}_{t-1}+\alpha \vg_{t-1}\right], t \geqslant 1 \\ 0, t=0\end{array}\right.
\end{align}
and 
\begin{align}
	\vp_{t+1} =  \beta \vp_t - \frac{\beta^2}{1 - \beta} \vg_t
	\label{eq:recursivep}
\end{align}
\begin{align}
	\underbrace{\overline{\vw}_{t+1} + \overline{\vp}_{t+1}}_{\overline{\vz}_{t+1}} &= \underbrace{\overline{\vw}_{t} + \overline{\vp}_{t}}_{\overline{\vz}_{t}} - \frac{\alpha}{1- \beta} \vg_t
	\label{eq:nasgdzt}
\end{align}

With the recursive equation \eq{\ref{eq:nasgdzt}}, we have the following 
inequality.
\begin{align}
	\EE\|\overline{\vz}_{t+1} - \vw^* \|^2  &= \EE\|\overline{\vz}_{t} - \eta_t\vg_t - \vw^* \|^2 \\
& \leq  \| \overline{\vz}_{t} - \vw^*\|^2  - 2\eta_t\left<\EE\vg_t, \overline{\vz}_{t} - \vw^*\right> +  \eta_t^2\EE\|\vg_t\|^2 \\
& \leq  \| \overline{\vz}_{t} - \vw^*\|^2  - 2\eta_t\sum_{k=1}^K p_k\left<\EE g_{t,k}, \overline{\vz}_{t} - \vw^*\right> +  \eta_t^2\EE\|\vg_t\|^2 \label{eq:nagcvx1}
\end{align}

where we set $\eta_t = \frac{\alpha}{1- \beta}$. Follow the same reasoning 
in \eq{\ref{eq:4}}, use convexity of the objective function, we have 
\begin{align}
   & - \left<\EE g_{t,k}, \overline{\vz}_{t} - \vw^*\right> \\
	\leq & \frac{1}{2\eta_t} \|\overline{\vz}_t - \vw_t^k\|^2 + \frac{\eta_t}{2} \|\EE \vg_{t,k}\|^2 - (F_k(\vw_t^k) - F_k(\vw^*)) \label{eq:nagcvx2}
\end{align}
Plug in \eq{\ref{eq:nagcvx2}} to \eq{\ref{eq:nagcvx1}}:
\begin{align}
	\EE\|\overline{\vz}_{t+1} - \vw^* \|^2 & \leq \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2\EE\|\vg_t\|^2  \\
	&  + \sum_{k=1}^K p_k \underbrace{\|\overline{\vz}_t - \vw_t^k\|^2}_{A_1}  +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2 \underbrace{- 2\eta_t\sum_{k=1}^K p_k(F_k(\vw_t^k) - F_k(\vw^*))}_{A_2} \label{eq:nagcvx3}
\end{align}
Bound $A_2$, use the convexity of $F_k$, same reasoning as \eq{\ref{eq:a24}}:
\begin{align*}
& -2\eta_t\sum_{k=1}^K p_k (F_k(\vw_t^k) - F_k(\vw^*)) \\
\leq &\sum_{k=1}^K p_k (\eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t) \|^2 +\|\vw_t^k - \overline{\vw}_t\|^2) -2\eta_t (F(\overline{w}_t) - F^*)
\end{align*}
Plug in the upper bound of $A_2$ into the \eq{\ref{eq:nagcvx3}}, 
\begin{align}
	\EE\|\overline{\vz}_{t+1} - \vw^* \|^2 & \leq \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2\EE\|\vg_t\|^2  \nonumber\\
	&  + \sum_{k=1}^K p_k \underbrace{\|\overline{\vz}_t - \vw_t^k\|^2}_{A_1}  +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2 \nonumber \\
	& + \sum_{k=1}^K p_k (\eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2 + \|\vw_t^k - \overline{\vw}_t\|^2) - 2\eta_t(F(\overline{w}_t) - F^*) 
	\label{eq:nagcvx4}
\end{align}
Bound $\EE\|\overline{\vz}_t - \vw_t^k\|^2$ and $\EE \|\overline{\vw}_t- \vw_t^k \|^2$, this is similar to the proof in Lemma 3~\cite{li2019convergence}: 

\begin{align}
	\EE \|\ov{\vw}_t -\vw_t^k \|^2 & = \EE \|\ov{w}_t - \ov{w}_{t_0} + \ov{w}_{t_0}- \vw_t^k \|^2\\
% & \leq \EE\|\ov{w}_{t_0}- \vw_t^k \|^2 + \EE \|\ov{w}_t - \ov{w}_{t_0}\|^2\\
& \leq \EE\|\vw_t^k  - \ov{w}_{t_0}\|^2  \\
& \leq \EE \|\vz_t^k - \vp_t^k  - \vz^k_{t_0} + \vp^k_{t_0}\|^2  \\
& \leq \EE \|\vz_t^k - \vz^k_{t_0}\|^2 + \EE\|\vp_t^k - \vp^k_{t_0}\|^2  \\
& = \EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2 + \EE\|\vp_t^k - \vp^k_{t_0}\|^2  \\
& = \EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2 + \frac{(\beta^{t-t_0}-1)^2\beta^4}{(1-\beta)^2}\EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2 + \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2  
\end{align}
where the second line is same from Lemma 3~\cite{li2019convergence}. $\ov{w}_{t_0} = \vw^k_{t_0}$ and $t_0$ is the step we communicate. In the third line, we use the \eq{\ref{eq:nasgdzt}}. In fourth line, we use \eq{\ref{eq:recursivep}}. 
The upper bound of $\EE\|\vp_t^k - \vp^k_{t_0}\|^2$ is given as follows:
\begin{align}
	\EE\|\vp_t^k - \vp^k_{t_0}\|^2 & = \EE\|\beta \vp^k_{t-1} - \frac{\beta^2}{1 - \beta} \vg_{t-1,k} - \vp^k_{t_0}\|^2\\
	&= \EE\|\beta^{t-t_0} \vp^k_{t_0} - \frac{\beta^2}{1 - \beta} \sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k} - \vp^k_{t_0}\|^2\\
	&= \EE\|(\beta^{t-t_0}-1) \vp^k_{t_0} - \frac{\beta^2}{1 - \beta} \sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2\\
	&= \EE\|(\beta^{t-t_0}-1) \vp^k_{t_0}\|^2 + \frac{\beta^2}{1 - \beta} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2\\
	&= (\beta^{t-t_0}-1)^2\EE\|\ov{p}_{t_0}\|^2 + \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2\\
	&= (\beta^{t-t_0}-1)^2\frac{\beta^4}{(1-\beta)^2}\EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2 + \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2 \label{eq:nagcvx5}
\end{align}

\begin{align}
	\EE \|\overline{\vz}_t - \vw_t^k\|^2 & =  \EE \|\overline{\vw}_t + \overline{\vp}_{t}  - \vw_t^k\|^2\\ 
 & \leq  \EE \|\overline{\vw}_t -\vw_t^k \|^2 + \EE\| \overline{\vp}_{t}\|^2  \\
 &  =\EE \|\overline{\vw}_t -\vw_t^k \|^2 + \frac{\beta^4}{(1-\beta)^2}\EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2 \label{eq:nagcvx6}
\end{align}
Plug in \eq{\ref{eq:nagcvx5}} and \eq{\ref{eq:nagcvx6}} into
\eq{\ref{eq:nagcvx4}}:
\begin{align}
	\EE\|\overline{\vz}_{t+1} - \vw^* \|^2 & \leq \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2\EE\|\vg_t\|^2  \nonumber\\
	&  + \sum_{k=1}^K p_k \|\overline{\vz}_t - \vw_t^k\|^2  +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2 \nonumber \\
	& + \sum_{k=1}^K p_k (\eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2 + \|\vw_t^k - \overline{\vw}_t\|^2) - 2\eta_t(F(\overline{w}_t) - F^*) \\
	& =  \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2\EE\|\vg_t\|^2 +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2  \nonumber\\
	& + \sum_{k=1}^K p_k \eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2  - 2\eta_t(F(\overline{w}_t) - F^*) \nonumber \\
	&  + \sum_{k=1}^K p_k \|\ov{p}_t\|^2 + 2\sum_{k=1}^K p_k \|\ov{w}_t - \vw_t^k\|^2  \\
	& \leq \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2\EE\|\vg_t\|^2 +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2  \nonumber\\
	& + \sum_{k=1}^K p_k \eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2  - 2\eta_t(F(\overline{w}_t) - F^*) \nonumber \\
	& + \sum_{k=1}^K p_k \left(\frac{\beta^4}{(1-\beta)^2}\EE\|\underline{\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j}\|^2 \right) \nonumber\\
	& + 2\sum_{k=1}^K p_k \left(\EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2 + \frac{(\beta^{t-t_0}-1)^2\beta^4}{(1-\beta)^2}\EE\|\underline{\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j}\|^2 + \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2 \right) \\
	& \leq \| \overline{\vz}_{t} - \vw^*\|^2  - 2\eta_t(F(\overline{w}_t) - F^*)  \nonumber\\
	& +  \eta_t^2\EE\|\vg_t\|^2 +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2 + \sum_{k=1}^K p_k \eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2  \nonumber \\
	& + \sum_{k=1}^K p_k \left(\frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{(1-\beta)^2} \EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2 \right) \nonumber\\
	& + 2\sum_{k=1}^K p_k \left(\EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2  + \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2 \right) \label{eq:nagcvx7}
\end{align}

Denote the last three lines in \eq{\ref{eq:nagcvx7}} as $C$: 
\begin{align}
C &= \eta_t^2\EE\|\vg_t\|^2 +\eta^2_t \sum_{k=1}^K p_k\|\EE \vg_{t,k}\|^2+ \sum_{k=1}^K p_k \eta_t^2 \|\EE \vg_{t,k}(\overline{\vw}_t)\|^2  \nonumber \\
% 2\sum_{k=1}^K p_k \EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2 
	& + \sum_{k=1}^K p_k \left(\underbrace{\frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{(1-\beta)^2} \EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2}_{C_1} \right) \nonumber\\
	& + 2\sum_{k=1}^K p_k \left(\underbrace{\EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2 }_{C_2} + \underbrace{\frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2}_{C_3} \right)  \label{eq:nagcvxc}
\end{align}



We now bound $C_1$, we set $\Lambda_{t_0} = \sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j} = \frac{1 - \beta^{t_0}}{1- \beta} \leq \frac{1}{1 - \beta}$, \lkxcom{assume $\beta \in (0, 1)$ and set $\alpha = \beta$}.
\begin{align}
	C_1 &=  \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{(1-\beta)^2} \EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2\\
        &= \eta_t^2 \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\alpha^2} \EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}\vg_j\|^2\\
        &= \eta_t^2  \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\alpha^2}\Lambda_{t_0}^2 \EE\|\sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}/\Lambda_{t_0} \vg_j\|^2\\
        & \leq \eta_t^2  \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\alpha^2}\Lambda_{t_0}^2 \sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j}/\Lambda_{t_0}\EE\| \vg_j\|^2\\ 
        & = \eta_t^2 \Lambda_{t_0} \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\alpha^2} \sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j} \EE\| \vg_j\|^2\\
		& \leq  \eta_t^2 \Lambda_{t_0} \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\alpha^2} \sum_{j=0}^{t_0 - 1}\beta^{t_0-1-j} \sum_{k=1}^N p_k G_k^2   \\
		& =  \eta_t^2 \Lambda_{t_0} \frac{\beta^4(2(\beta^{t-t_0}-1)^2 + 1)}{\beta^2} \Lambda_{t_0}  \sum_{k=1}^N p_k G_k^2  \\
		& \leq  \eta_t^2 \frac{1}{(1-\beta)^2} \frac{\beta^2(2 \times 1 + 1)}{1} \sum_{k=1}^N p_k G_k^2   \\
		& \leq  3 \eta_t^4\sum_{k=1}^N p_k G_k^2   \label{eq:nagcvxc1}
\end{align}
In the fourth line we use the Jensen's inequality. In the fifth line, we use the assumption~\ref{ass:subgrad2}. 


To bound $C_2$, we assume $\eta_t$ is non-increasing and $\eta_t  \leq \eta_{t_0}  \leq 2 \eta_t$
\begin{align}
 C_2 = & 2\sum_{k=1}^K p_k \EE \|\sum_{j=t_0}^{t-1}\eta_j \vg_{j,k}\|^2\\
 \leq& 2\sum_{k=1}^K p_k \eta_{t_0}^2 \EE \|\sum_{j=t_0}^{t-1} \vg_{j,k}\|^2
 \leq 2\sum_{k=1}^K p_k  (E-1)\sum_{j=t_0}^{t-1}\eta_{j}^2 \EE \| \vg_{j,k}\|^2\\
 \leq & 2\sum_{k=1}^K p_k  (E-1)\eta_{t_0}^2 \sum_{j=t_0}^{t-1} \EE \| \vg_{j,k}\|^2\\
 \leq & 2\sum_{k=1}^K p_k  (E-1)4\eta_{t}^2 \sum_{j=t_0}^{t-1} \EE \| \vg_{j,k}\|^2 \leq 8(E-1)\eta_{t}^2 \sum_{k=1}^K p_k \sum_{j=t_0}^{t-1} \EE \| \vg_{j,k}\|^2 \\
 \leq & 8(E-1)\eta_{t}^2 \sum_{k=1}^K p_k (E-1)G_k^2 \\
 =  & 8(E-1)^2\eta_{t}^2 \sum_{k=1}^K p_k G_k^2   \label{eq:nagcvxc2}
\end{align}
To bound $C_3$, similar to $C_1$, we set $\Lambda_{t_0}^{t} = \sum_{j=t_0}^{t - 1}\beta^{t_0-1-j} =  \frac{1 - \beta^{t-t_0}}{1- \beta} \leq \frac{1}{1 - \beta} $
\begin{align}
	C_3 & = 2\sum_{k=1}^K p_k \frac{\beta^4}{(1 - \beta)^2} \EE\|\sum_{j=t_0}^{t-1}\beta^{t-j-1}\vg_{j,k}\|^2\\
        & = 2\eta_t^2 \Lambda_{t_0}^{t}\sum_{k=1}^K p_k \frac{\beta^4}{\alpha^2} \sum_{j=t_0}^{t-1}\beta^{t-j-1} \EE\|\vg_{j,k}\|^2 \\
        & \leq 2 \eta_t^4 \sum_{k=1}^K p_k G_k^2  \label{eq:nagcvxc3}
\end{align}

Based on \eq{\ref{eq:nagcvxc}}, \eq{\ref{eq:nagcvxc1}}, \eq{\ref{eq:nagcvxc2}}, and \eq{\ref{eq:nagcvxc3}}, we can denote $C = \eta_t^2 D$, 
plug in $C$ back to \eq{\ref{eq:nagcvx7}}, we have 
\begin{align}
\EE\|\overline{\vz}_{t+1} - \vw^* \|^2 & \leq \EE \| \overline{\vz}_{t} - \vw^*\|^2  +  \eta_t^2 D   - 2\eta_t(F(\overline{w}_t) - F^*) \nonumber\\	
 2\eta_t(F(\overline{w}_t) - F^*) & \leq  \Delta_{t}  - \Delta_{t+1}  +  \eta_t^2 D    \nonumber
\end{align}

Sum two sides over time step $t$:
\begin{align}
\frac{1}{T}\sum_{t=0}^{T-1} 2 \eta (F(\overline{w}_t) - F^*) & \leq \Delta_0 - \Delta_{T} + \sum_{t=0}^{T-1} \eta^2 D \nonumber\\
\frac{1}{T}\sum_{t=0}^{T-1} 2 \eta (F(\overline{w}_t) - F^*) & \leq \Delta_0/T  + \sum_{t=0}^{T-1} \eta^2 D/T\nonumber\\
 F(\hat{w}_t) - F^* & \leq \frac{\Delta_0}{2T\eta}   + \frac{\eta D}{2}\nonumber\\
 F(\hat{w}_t) - F^* & \leq \sqrt{\frac{\Delta_0D}{T}} \nonumber\\
\end{align}
where $\hat{w}_t = \frac{1}{T}\sum_{t=0}^{T-1} \ov{w}_t$, $\eta = \sqrt{\frac{\Delta_0}{DT}}$.



\begin{itemize}
	\item Update NASG or MSG.
	\item Store the momentum every $E$~\cite{huo2020faster} , every step~\cite{liu2019accelerating}, rely on L-smoothness.
\end{itemize}











