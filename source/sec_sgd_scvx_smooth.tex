We show that FedAvg with SGD has $O(1/NT)$ rate under $\mu$-strong
convexity and $L$-smoothness. The result improves on the ICLR paper's
$O(1/T)$ with a linear speedup in the number of devices $N$. {[}TODO:
Add more comment here.{]} The FedAv algorithm with SGD follows the
updates
\begin{align*}
y_{t+1}^{k} & =w_{t}^{k}-\alpha_{t}g_{t,k}\\
w_{t+1}^{k} & =\begin{cases}
y_{t+1}^{k} & \text{if }t+1\notin\mathcal{I}_{E}\\
\sum_{k=1}^{N}p_{k}y_{t+1}^{k} & \text{if }t+1\in\mathcal{I}_{E}
\end{cases}
\end{align*}
 where 
\begin{align*}
g_{t,k} & :=\nabla F_{k}(w_{t}^{k},\xi_{t}^{k})
\end{align*}
 is the stochastic gradient. 

Define the virtual sequences $\overline{y}_{t}=\sum_{k=1}^{N}p_{k}y_{t}^{k}$,
$\overline{w}_{t}=\sum_{k=1}^{N}p_{k}w_{t}^{k}$, and $\overline{g}_{t}=\sum_{k=1}^{N}p_{k}\mathbb{E}g_{t,k}$.
We have $\mathbb{E}g_{t}=\overline{g}_{t}$ and $\overline{y}_{t+1}=\overline{w}_{t}-\alpha_{t}g_{t}$,
and $\overline{w}_{t+1}=\overline{y}_{t+1}$ for all $t$. 

%
\begin{assumption}
The stochastic gradients have bounded variance 
\begin{align*}
\mathbb{E}\|\nabla F_{k}(w_{t}^{k},\xi_{t}^{k})-\nabla F_{k}(w_{t}^{k})\|^{2} & \leq\sigma_{k}^{2}
\end{align*}
for all $k$. Moreover, the expected squared norm of stochastic gradients
is uniformly bounded, 
\begin{align*}
\mathbb{E}\|\nabla F_{k}(w_{t}^{k},\xi_{t}^{k})\|^{2} & \leq G^{2}
\end{align*}
\end{assumption}
\begin{theorem}
(Full device participation) Suppose $F_{k}$ is $L$-smooth and $\mu$-strongly
convex for all $k$. Let $\kappa=\frac{L}{\mu}$, $\gamma=\max\{8\kappa-1,E\}$
where $E$ is the communication interval, and learning rates 
\begin{align*}
\alpha_{t} & =\frac{c}{\mu(\gamma+t)}
\end{align*}
so that $\alpha_{t}\leq2\alpha_{t+E}$, and where $0\leq c\leq1$
is small enough such that the following hold: 
\begin{align*}
\alpha_{t} & \leq\frac{1}{4L}\\
\alpha_{t} & \leq\frac{1}{N}
\end{align*}
 for all $t\geq0$. 

Then with full device participation,
\begin{align*}
\mathbb{E}F(w_{T})-F^{\ast} & \leq C\frac{\kappa}{N(\gamma+t)}\\
C & =4E^{2}LG^{2}+\nu_{max}^{2}\sigma^{2}+LG^{2}
\end{align*}
 
\end{theorem}
\begin{proof}
The idea of the proof is to observe that the $L$-smoothness of $F$
provides the upper bound
\begin{align*}
\mathbb{E}(F(\overline{w}_{t}))-F^{\ast} & =\mathbb{E}(F(\overline{w}_{t})-F(w^{\ast}))\\
 & \leq\frac{L}{2}\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2}
\end{align*}
 and to show that $\mathbb{E}\|\overline{w}_{T}-w^{\ast}\|^{2}=O(\frac{1}{NT})$. 

Our main step is to prove the bound 
\begin{align*}
\mathbb{E}\|\overline{w}_{t+1}-w^{\ast}\|^{2} & \leq(1-\mu\alpha_{t})\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2}+\alpha_{t}^{2}B
\end{align*}
 where $B$ is define in the statement of the theorem. 

We have 
\begin{align*}
\|\overline{w}_{t+1}-w^{\ast}\|^{2} & =\|(\overline{w}_{t}-\alpha_{t}g_{t})-w^{\ast}\|^{2}\\
 & =\|(\overline{w}_{t}-\alpha_{t}\overline{g}_{t}-w^{\ast})-\alpha_{t}(g_{t}-\overline{g}_{t})\|^{2}\\
 & =A_{1}+A_{2}+A_{3}
\end{align*}
where 
\begin{align*}
A_{1} & =\|\overline{w}_{t}-w^{\ast}-\alpha_{t}\overline{g}_{t}\|^{2}\\
A_{2} & =2\alpha_{t}\langle\overline{w}_{t}-w^{\ast}-\alpha_{t}\overline{g}_{t},\overline{g}_{t}-g_{t}\rangle\\
A_{3} & =\alpha_{t}^{2}\|g_{t}-\overline{g}_{t}\|^{2}
\end{align*}
 $\mathbb{E}A_{2}=0$ by definition of $g_{t}$ and $\overline{g}_{t}$,
while for $A_{3}$ we have
\begin{align*}
\alpha_{t}^{2}\mathbb{E}\|g_{t}-\overline{g}_{t}\|^{2} & =\alpha_{t}^{2}\mathbb{E}\|g_{t}-\mathbb{E}g_{t}\|^{2}=\alpha_{t}^{2}\sum_{k=1}^{N}p_{k}^{2}\|g_{t,k}-\mathbb{E}g_{t,k}\|^{2}\leq\alpha_{t}^{2}\sum_{k=1}^{N}p_{k}^{2}\sigma_{k}^{2}
\end{align*}
 again by Jensen's inequality and using the independence of $g_{t,k},g_{t,k'}$. 

Next we bound $A_{1}$: 
\begin{align*}
\|\overline{w}_{t}-w^{\ast}-\alpha_{t}\overline{g}_{t}\|^{2} & =\|\overline{w}_{t}-w^{\ast}\|^{2}+2\langle\overline{w}_{t}-w^{\ast},-\alpha_{t}\overline{g}_{t}\rangle+\|\alpha_{t}\overline{g}_{t}\|^{2}
\end{align*}
and we will show that the third term $\|\alpha_{t}\overline{g}_{t}\|^{2}$
can be canceled by an upper bound of the second term. %


Now 
\begin{align*}
-2\alpha_{t}\langle\overline{w}_{t}-w^{\ast},\overline{g}_{t}\rangle & =-2\alpha_{t}\sum_{k=1}^{N}p_{k}\langle\overline{w}_{t}-w^{\ast},\nabla F_{k}(w_{t}^{k})\rangle\\
 & =-2\alpha_{t}\sum_{k=1}^{N}p_{k}\langle\overline{w}_{t}-w_{t}^{k},\nabla F_{k}(w_{t}^{k})\rangle-2\alpha_{t}\sum_{k=1}^{N}p_{k}\langle w_{t}^{k}-w^{\ast},\nabla F_{k}(w_{t}^{k})\rangle\\
 & \leq-2\alpha_{t}\sum_{k=1}^{N}p_{k}\langle\overline{w}_{t}-w_{t}^{k},\nabla F_{k}(w_{t}^{k})\rangle+2\alpha_{t}\sum_{k=1}^{N}p_{k}(F_{k}(w^{\ast})-F_{k}(w_{t}^{k}))\\
 & \leq2\alpha_{t}\sum_{k=1}^{N}p_{k}\left[F_{k}(w_{t}^{k})-F_{k}(\overline{w}_{t})+\frac{L}{2}\|\overline{w}_{t}-w_{t}^{k}\|^{2}+F_{k}(w^{\ast})-F_{k}(w_{t}^{k})\right]\\
 & =\alpha_{t}L\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}+2\alpha_{t}\sum_{k=1}^{N}p_{k}\left[F_{k}(w^{\ast})-F_{k}(\overline{w}_{t})\right]
\end{align*}
For the second term, which is negative, we can ignore it, but this
yields a suboptimal bound that fails to provide the desired linear
speedup. This is the flaw in the analysis of the ICLR paper. Instead,
we upper bound it using the following derivation: 
\begin{align*}
2\alpha_{t}\sum_{k=1}^{N}p_{k}\left[F_{k}(w^{\ast})-F_{k}(\overline{w}_{t})\right] & \leq2\alpha_{t}\left[F(\overline{w}_{t+1})-F(\overline{w}_{t})\right]\\
 & \leq2\alpha_{t}\mathbb{E}\langle\nabla F(\overline{w}_{t}),\overline{w}_{t+1}-\overline{w}_{t}\rangle+\alpha_{t}L\mathbb{E}\|\overline{w}_{t+1}-\overline{w}_{t}\|^{2}\\
 & =-2\alpha_{t}^{2}\mathbb{E}\langle\nabla F(\overline{w}_{t}),g_{t}\rangle+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & =-2\alpha_{t}^{2}\mathbb{E}\langle\nabla F(\overline{w}_{t}),\overline{g}_{t}\rangle+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & =-\alpha_{t}^{2}\left[\|\nabla F(\overline{w}_{t})\|^{2}+\|\overline{g}_{t}\|^{2}-\|\nabla F(\overline{w}_{t})-\overline{g}_{t}\|^{2}\right]+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & =-\alpha_{t}^{2}\left[\|\nabla F(\overline{w}_{t})\|^{2}+\|\overline{g}_{t}\|^{2}-\|\nabla F(\overline{w}_{t})-\sum_{k}p_{k}\nabla F(w_{t}^{k})\|^{2}\right]+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & \leq-\alpha_{t}^{2}\left[\|\nabla F(\overline{w}_{t})\|^{2}+\|\overline{g}_{t}\|^{2}-\sum_{k}p_{k}\|\nabla F(\overline{w}_{t})-\nabla F(w_{t}^{k})\|^{2}\right]+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & \leq-\alpha_{t}^{2}\left[\|\nabla F(\overline{w}_{t})\|^{2}+\|\overline{g}_{t}\|^{2}-L^{2}\sum_{k}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}\right]+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}\\
 & \leq-\alpha_{t}^{2}\|\overline{g}_{t}\|^{2}+\alpha_{t}^{2}L^{2}\sum_{k}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}
\end{align*}
where we have used the smoothness of $F$ twice. 

Note that the term $-\alpha_{t}^{2}\|\overline{g}_{t}\|^{2}$ exactly
cancels the $\alpha_{t}^{2}\|\overline{g}_{t}\|^{2}$ in the bound
for $A_{1}$, so that plugging in the bound for $-2\alpha_{t}\langle\overline{w}_{t}-w^{\ast},\overline{g}_{t}\rangle$,
we have so far proved 
\begin{align*}
\mathbb{E}\|\overline{w}_{t+1}-w^{\ast}\|^{2} & \leq\mathbb{E}(1-\mu\alpha_{t})\|\overline{w}_{t}-w^{\ast}\|^{2}+\alpha_{t}L\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}+\alpha_{t}^{2}\sum_{k=1}^{N}p_{k}^{2}\sigma_{k}^{2}\\
 & +\alpha_{t}^{2}L^{2}\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}+\alpha_{t}^{3}L\mathbb{E}\|g_{t}\|^{2}
\end{align*}
 The term $\mathbb{E}\|g_{t}\|^{2}\leq G^{2}$ by assumption. 

Now we bound $\mathbb{E}\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}$.
Since communication is done every $E$ steps, for any $t\geq0$, we
can find a $t_{0}\leq t$ such that $t-t_{0}\leq E-1$ and $w_{t_{0}}^{k}=\overline{w}_{t_{0}}$for
all $k$. Moreover, using $\eta_{t}$ is non-increasing and $\alpha_{t_{0}}\leq\alpha{}_{t}$
for any $t-t_{0}\leq E-1$, we have 
\begin{align*}
\mathbb{E}\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2} & =\mathbb{E}\sum_{k=1}^{N}p_{k}\|w_{t}^{k}-\overline{w}_{t_{0}}-(\overline{w}_{t}-\overline{w}_{t_{0}})\|^{2}\\
 & \leq\mathbb{E}\sum_{k=1}^{N}p_{k}\|w_{t}^{k}-\overline{w}_{t_{0}}\|^{2}\\
 & =\mathbb{E}\sum_{k=1}^{N}p_{k}\|w_{t}^{k}-w_{t_{0}}^{k}\|^{2}\\
 & =\mathbb{E}\sum_{k=1}^{N}p_{k}\|-\sum_{i=t_{0}}^{t-1}\alpha_{i}g_{i,k}\|^{2}\\
 & \leq\sum_{k=1}^{N}p_{k}\mathbb{E}\sum_{i=t_{0}}^{t-1}(E-1)\alpha_{i}^{2}\|g_{i,k}\|^{2}\\
 & \leq\sum_{k=1}^{N}p_{k}\mathbb{E}\sum_{i=t_{0}}^{t-1}(E-1)\alpha_{t_{0}}^{2}G^{2}\\
 & \leq4E^{2}\alpha_{t}^{2}G^{2}
\end{align*}

Using the bound on $\mathbb{E}\sum_{k=1}^{N}p_{k}\|\overline{w}_{t}-w_{t}^{k}\|^{2}$,
we can conclude that, with $\nu_{max}:=N\cdot\max_{k}p_{k}$ and $\nu_{min}:=N\cdot\min_{k}p_{k}$, 

\begin{align*}
\mathbb{E}\|\overline{w}_{t+1}-w^{\ast}\|^{2} & \leq\mathbb{E}(1-\mu\alpha_{t})\|\overline{w}_{t}-w^{\ast}\|^{2}+4E^{2}L\alpha_{t}^{3}G^{2}+4E^{2}L^{2}\alpha_{t}^{4}G^{2}+\alpha_{t}^{2}\sum_{k=1}^{N}p_{k}^{2}\sigma_{k}^{2}+\alpha_{t}^{3}LG^{2}\\
 & =\mathbb{E}(1-\mu\alpha_{t})\|\overline{w}_{t}-w^{\ast}\|^{2}+4E^{2}L\alpha_{t}^{3}G^{2}+4E^{2}L^{2}\alpha_{t}^{4}G^{2}+\alpha_{t}^{2}\frac{1}{N^{2}}\sum_{k=1}^{N}(p_{k}N)^{2}\sigma_{k}^{2}+\alpha_{t}^{3}LG^{2}\\
 & \leq\mathbb{E}(1-\mu\alpha_{t})\|\overline{w}_{t}-w^{\ast}\|^{2}+4E^{2}L\alpha_{t}^{3}G^{2}+4E^{2}L^{2}\alpha_{t}^{4}G^{2}+\alpha_{t}^{2}\frac{1}{N^{2}}\nu_{max}^{2}\sum_{k=1}^{N}\sigma_{k}^{2}+\alpha_{t}^{3}LG^{2}\\
 & \leq\mathbb{E}(1-\mu\alpha_{t})\|\overline{w}_{t}-w^{\ast}\|^{2}+4E^{2}L\alpha_{t}^{3}G^{2}+4E^{2}L^{2}\alpha_{t}^{4}G^{2}+\alpha_{t}^{2}\frac{1}{N}\nu_{max}^{2}\sigma^{2}+\alpha_{t}^{3}LG^{2}
\end{align*}
 where $\sigma^{2}=\max_{k}\sigma_{k}^{2}$. The leading term in the
bound is $\alpha_{t}^{2}\frac{1}{N}\nu_{max}^{2}\sigma^{2}$, which
one summed using the recursive relations gives $O(\alpha_{t})$, but
the constant now is scaled down by $1/N$. To achieve this linear
speedup, we need $\sum_{t=0}^{T}(1-\mu\alpha_{t})\|w_{0}-w^{\ast}\|^{2}$
to be small enough. 

To complete the proof of convergence, for $\alpha_{t}=\frac{\delta}{t+\gamma}$
for $\delta>\frac{1}{\mu}$ and $\gamma>0$ such that $\alpha_{1}\leq\min\{\frac{1}{\mu},\frac{1}{4L}\}$and
$\alpha_{t}\leq2\alpha_{t+E}$, we can show that 
\begin{align*}
\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2} & \leq\frac{v}{N(\gamma+t)}
\end{align*}
 where $v=\max\{\frac{\delta^{2}B'}{\delta\mu-c+1},(\gamma+1)\|w_{0}-w^{\ast}\|^{2}\}$
by induction. The definition of $v$ ensures that 
\begin{align*}
\|w_{0}-w^{\ast}\|^{2} & \leq\frac{v}{\gamma}
\end{align*}
 and suppose $\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2}\leq\frac{v}{N(\gamma+t)}$
holds for some $t\geq0$. Then 
\begin{align*}
\mathbb{E}\|\overline{w}_{t+1}-w^{\ast}\|^{2}\leq & (1-\alpha_{t}\mu)\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2}+\alpha_{t}^{2}B'\\
 & \leq(1-\frac{\delta\mu}{t+\gamma})\frac{v}{t+\gamma}+\frac{\delta^{2}B'}{(t+\gamma)^{2}}\\
 & =\frac{t+\gamma-1}{(t+\gamma)^{2}}v+\left[\frac{\delta^{2}B'}{(t+\gamma)^{2}}-\frac{\delta\mu-1}{(t+\gamma)^{2}}v\right]\\
 & \leq\frac{v}{t+\gamma+1}
\end{align*}
 by definition of $v$.

Finally, the $L$-smoothness of $F$ implies 
\begin{align*}
\mathbb{E}(F(\overline{w}_{t}))-F^{\ast} & =\mathbb{E}(F(\overline{w}_{t})-F(w^{\ast}))\\
 & \leq\frac{L}{2}\mathbb{E}\|\overline{w}_{t}-w^{\ast}\|^{2}\leq\frac{L}{2}\frac{v}{\gamma+t}
\end{align*}
 Now if we choose $\delta=\frac{c}{\mu}$ where $c\leq1$ is small
enough such that the required conditions 
\begin{align*}
\alpha_{t}^{2}+\beta_{t-1}^{2} & \leq\frac{1}{2}\\
\alpha_{t} & \leq\frac{1}{4L}\\
4\alpha_{t-1}^{2} & \leq\alpha_{t}
\end{align*}
hold for all $t\geq0$, $\gamma=\max\{8\kappa-1,E\}$, then $\alpha_{t}=\frac{c}{\mu}\frac{1}{\gamma+t}$
and recalling $v=\max\{\frac{\delta^{2}B'}{\delta\mu-c+1},(\gamma+1)\|w_{0}-w^{\ast}\|^{2}\}$,
we finally have 
\begin{align*}
\mathbb{E}(F(\overline{w}_{t}))-F^{\ast} & \leq\frac{L}{2}\frac{v}{\gamma+t}\leq\frac{L/2}{\gamma+t}(\frac{\delta^{2}B'}{\delta\mu-c+1}+(\gamma+1)\|w_{0}-w^{\ast}\|^{2})\\
 & \leq\frac{\kappa}{\gamma+t}(\frac{B'}{\mu}+4L\|w_{0}-w^{\ast}\|^{2})
\end{align*}
\end{proof}